Lab – Implement Fine-Grain Access Controls
--------------------------------------------

Up to this point any authenticated user to the API is authorized to use them.  In this section we will strict user1's ability to create users, but will still be able to modify the user's employee number.

Task – Retrieve Group Membership Subsession Variable
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. From the Jumpbox decktop click on the **BIG-IP1** Putty Icon 

|image47|

.. TODO::   NEED TO TALK TO LUCAS



Task – Edit the per-request policy  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. From the Jumpbox, access the BIG-IP GUI https://10.1.1.4 (you can double-click on the BIG-IP1 bookmark from Chrome).

#. Login into the BIG-IP Configuration Utility with the following credentials:
User: **admin**
Password: **admin**


#. Click on the **Access** tab located on the left side.

|image0|

#. Navigate to API Protection >> Profile.  Click **Profile** to modify the previously created API protection Profile.  Not the + Plus symbol.

|image48|

#. Click **Edit** Under Per-Request Policy

|image49|

#. Click the **+ (Plus Symbol)** on the GET /aduser/create branch

|image50|

#. Click the **General Purpose** Tab
#. Select **Empty** 
#. Click **Add Item**

|image51|

#. Enter the name **Claim Check**

|image53|

#. Click the **Branch Rules** Tab
#. Click the **Add Branch Rule**

|image52|

#. Enter Name **CreateUser**
#. Click **Change**

|image54|


#. Click the **Advanced** Tab
#. Enter the string in the notes section to restrict access to only members of the **CreateUser** Group
#. Click **Finished**

.. Note :: expr {[mcget {subsession.oauth.scope./Common/as-jwt-provider.jwt.groups}] contains "CreateUser"}

|image55|

#. Click **Save**

|image56|

#. Click **Reject** on the CreateUser Branch to permit access 

|image57|

#. Select **Allow**
#. Click **Save**

|image58|

#. Click **Allow** on the fallback branch to deny unprivileged requests

|image59|

#. Select **Deny**
#. Click **Save**

|image60|

#. Review the Policy Flow.

|image61|


Task – Test the Fine-Grain Access Control with user1  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


#. From the Jumpbox, open Postman 

|image23|

#. Expand the **API Protection** Collection


#. Select the request **GET-Create User-JWT-Pass**

|image45|

#. Select the **Authorization** Tab
#. Click **Get New Access Token**

|image44|

#. Review the Postman Configuration.  Nothing should need to be modified
#. Click **Request Token**

|image27|

#. Login using Username: **user1**, Password: **user1**

|image28|

#. Scroll down the token and click **Use Token**

|image29|


#. The Token field is now populated

|image34|

#. Click **Send**


#. You receive a 403 Forbidden when using user1. User1 does not contain the proper claim data.


|image26|


Task – Test the Fine-Grain Access Control with user2  
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


#. Select the request **GET-Create User-JWT-Pass**

|image45|

#. Select the **Authorization** Tab
#. Click **Get New Access Token**

|image44|

#. Review the Postman Configuration.  Nothing should need to be modified
#. Click **Request Token**

|image27|

#. Login using Username: **user2**, Password: **user2**

|image62|

#. Scroll down the token and click **Use Token**

|image29|


#. The Token field is now populated

|image34|

#. Click **Send**


#. You receive a 200 OK when using user2. User2 does contain the proper claim data.


|image46|



.. |image0| image:: /_static/class1/module2/image000.png
.. |image23| image:: /_static/class1/module2/image023.png
.. |image26| image:: /_static/class1/module2/image026.png
.. |image27| image:: /_static/class1/module2/image027.png
.. |image28| image:: /_static/class1/module2/image028.png
.. |image29| image:: /_static/class1/module2/image029.png
.. |image34| image:: /_static/class1/module2/image034.png
.. |image44| image:: /_static/class1/module2/image044.png
.. |image45| image:: /_static/class1/module2/image045.png
.. |image46| image:: /_static/class1/module2/image046.png
.. |image47| image:: /_static/class1/module2/image047.png
.. |image48| image:: /_static/class1/module2/image048.png
.. |image49| image:: /_static/class1/module2/image049.png
.. |image50| image:: /_static/class1/module2/image050.png
.. |image51| image:: /_static/class1/module2/image051.png
.. |image52| image:: /_static/class1/module2/image052.png
.. |image53| image:: /_static/class1/module2/image053.png
.. |image54| image:: /_static/class1/module2/image054.png
.. |image55| image:: /_static/class1/module2/image055.png
.. |image56| image:: /_static/class1/module2/image056.png
.. |image57| image:: /_static/class1/module2/image057.png
.. |image58| image:: /_static/class1/module2/image058.png
.. |image59| image:: /_static/class1/module2/image059.png
.. |image60| image:: /_static/class1/module2/image060.png
.. |image61| image:: /_static/class1/module2/image061.png
.. |image62| image:: /_static/class1/module2/image062.png
.. |image63| image:: /_static/class1/module2/image063.png





