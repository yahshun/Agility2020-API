Lab – Implement Rate Limiting
=============================

The API Protection Profile allows a BIG-IP administrator to throttle the amount of connections to an API through the use of Key Names.

Task – Test access pre-ratelimiting
-----------------------------------

1. From the Jumpbox, open **Postman**

|image23|

2. Expand the **API Protection** Collection

3. Select the request **GET-Retrieve User Attributes-JWT-Pass**

|image42|

4. Select the **Authorization** Tab

|image43|

5. Click **Get New Access Token**

|image44|

6. Review the Postman Configuration.  Nothing should need to be modified

7. Click **Request Token**

|image27|

8. Login using Username: **user1**, Password: **user1**

|image28|

9. Scroll down the token and click **Use Token**

|image29|

10. Notice the **Access Token** field is now populated

|image34|

11. Click **Send**

12. You receive a **200 OK** response status code with attributes for user1 in the body of the response

|image31|

13. Click **Save**

|image88|

14. Click **Runner** located in the left corner

|image89|

15. Expand the **API Protection** collection

|image90|

16. Deselect all requests except **GET-Retrieve User Attributes-JWT-Pass**

17. Set the iterations to **100**

18. Click **Run API Protection**

|image91|

19. You receive a **200 OK** for every request

|image92|


Task – Define the rate limiting keys
------------------------------------

20. From the Jumpbox, access the BIG-IP GUI https://10.1.1.4 (you can double-click on the BIG-IP1 bookmark from Chrome)

21. Login into the BIG-IP Configuration Utility with the following credentials:

- User: **admin**
- Password: **admin**

22. Click on the **Access** tab located on the left side.

|image0|

23. Navigate to API Protection >> Profile.  Click **Profile** to modify the previously created API protection Profile.  Not the + Plus symbol.

|image48|

24. Click **api-protection**

|image64|

25. Click **Rate Limiting** from the top ribbon


|image69|

.. Note ::  The API protection profile default settings contains five Key Names created, but their values are empty.  Additional Keys can be created if necessary

26. Click **api-protection_auto_rate_limiting_key1**

27. Enter the Key Value **%{subsession.oauth.scope./Common/as-jwt-provider.jwt.user}**

28. Enter the Key Value **%{subsession.oauth.scope./Common/as-jwt-provider.jwt.user}**

29. Click **Edit**

|image71|

30. Click **api-protection_auto_rate_limiting_key2**

31. Enter the Key Value **%{subsession.oauth.scope./Common/as-jwt-provider.jwt.groupid}**

32. Enter the Key Value **%{subsession.oauth.scope./Common/as-jwt-provider.jwt.groupid}**

33. Click **Edit**

|image73|

34. Click **api-protection_auto_rate_limiting_key3**

|image74|

35. Enter the Key Value **%{subsession.oauth.scope./Common/as-jwt-provider.jwt.client}**

36. Click **Edit**

|image75|

37. Click **api-protection_auto_rate_limiting_key4**

38. Enter the Key Value **%{subsession.oauth.scope./Common/as-jwt-provider.jwt.tier}**

39. Click **Edit**

|image77|

40. Click **api-protection_auto_rate_limiting_key5**

|image78|

41. Enter the Key Value **%{subsession.oauth.scope./Common/as-jwt-provider.jwt.org}**

42. Click **Edit**

|image79|

43. Click **Save**

|image80|

Task – Create a Rate Limiting Policy
------------------------------------

44. Click **Create** in the rate limiting section

|image81|

45. Enter the Name **acme-rate-limits**

46. Move all five keys under **Selected Keys**

47. Enter **10** for the number of requests per minute

48. Enter **5** for the number requests per second

49. Click **Add**.

|image82|

50. Click **Save**

|image83|


Task – Apply the Rate Limiting Policy
-------------------------------------

51. Click **Rate Limiting** from the ribbon

|image93|

52. Click **Edit** Per Request Policy

|image94|

53. Click the **+ (Plus Symbol)** on the **Out** branch of the **OAuth Scope Check AuthZ** Macro

|image95|

54. Click the **Traffic Management** tab

55. Select **API Rate Limiting**

56. Click **Add Item**

|image96|

57. Click **Add new entry**

58. Select **acme-rate-limits**

59. Click **Save**

|image97|

60. Verify the Rate Limiting agent now appears in the appropriate location

|image98|


Task – Test Rate Limiting
-------------------------

61. From the Jumpbox, open Postman

|image23|

62. Expand the API Protection Collection

63. Select the request **GET-Retrieve User Attributes-JWT-Pass**

|image42|

64. Select the **Authorization** Tab

|image43|

65. Click **Get New Access Token**

|image44|

66. Review the Postman Configuration. Nothing should need to be modified

67. Click **Request Token**

|image27|

68. Login using Username: **user1**, Password: **user1**

|image28|

69. Scroll down the token and click **Use Token**

|image29|

70. Notice the Access Token field is now populated

|image34|

71. Click **Send**

72. You receive a **200 OK** response status code with attributes for user1 in the body of the response

|image31|

73. Click **Save**

|image88|

74. Click **Runner** located in the left corner

|image89|

75. Expand the **API Protection** collection

|image90|

76. Deselect all requests except **GET-Retrieve User Attributes-JWT-Pass**

77. Set the iterations to **100**

78. Click **Run API Protection**

|image91|

79. On the 6th request you begin to receive a **429 Too Many Requests** response status code

|image99|


.. |image0| image:: /_static/class1/module2/image000.png
.. |image23| image:: /_static/class1/module2/image023.png
.. |image26| image:: /_static/class1/module2/image026.png
.. |image27| image:: /_static/class1/module2/image027.png
.. |image28| image:: /_static/class1/module2/image028.png
.. |image29| image:: /_static/class1/module2/image029.png
.. |image31| image:: /_static/class1/module2/image031.png
.. |image34| image:: /_static/class1/module2/image034.png
.. |image39| image:: /_static/class1/module2/image039.png
.. |image42| image:: /_static/class1/module2/image042.png
.. |image43| image:: /_static/class1/module2/image043.png
.. |image44| image:: /_static/class1/module2/image044.png
.. |image45| image:: /_static/class1/module2/image045.png
.. |image46| image:: /_static/class1/module2/image046.png
.. |image47| image:: /_static/class1/module2/image047.png
.. |image48| image:: /_static/class1/module2/image048.png
.. |image49| image:: /_static/class1/module2/image049.png
.. |image50| image:: /_static/class1/module2/image050.png
.. |image51| image:: /_static/class1/module2/image051.png
.. |image52| image:: /_static/class1/module2/image052.png
.. |image53| image:: /_static/class1/module2/image053.png
.. |image54| image:: /_static/class1/module2/image054.png
.. |image55| image:: /_static/class1/module2/image055.png
.. |image56| image:: /_static/class1/module2/image056.png
.. |image57| image:: /_static/class1/module2/image057.png
.. |image58| image:: /_static/class1/module2/image058.png
.. |image59| image:: /_static/class1/module2/image059.png
.. |image60| image:: /_static/class1/module2/image060.png
.. |image61| image:: /_static/class1/module2/image061.png
.. |image62| image:: /_static/class1/module2/image062.png
.. |image63| image:: /_static/class1/module2/image063.png
.. |image64| image:: /_static/class1/module2/image064.png
.. |image65| image:: /_static/class1/module2/image065.png
.. |image66| image:: /_static/class1/module2/image066.png
.. |image67| image:: /_static/class1/module2/image067.png
.. |image68| image:: /_static/class1/module2/image068.png
.. |image69| image:: /_static/class1/module2/image069.png
.. |image70| image:: /_static/class1/module2/image070.png
.. |image71| image:: /_static/class1/module2/image071.png
.. |image72| image:: /_static/class1/module2/image072.png
.. |image73| image:: /_static/class1/module2/image073.png
.. |image74| image:: /_static/class1/module2/image074.png
.. |image75| image:: /_static/class1/module2/image075.png
.. |image76| image:: /_static/class1/module2/image076.png
.. |image77| image:: /_static/class1/module2/image077.png
.. |image78| image:: /_static/class1/module2/image078.png
.. |image79| image:: /_static/class1/module2/image079.png
.. |image80| image:: /_static/class1/module2/image080.png
.. |image81| image:: /_static/class1/module2/image081.png
.. |image82| image:: /_static/class1/module2/image082.png
.. |image83| image:: /_static/class1/module2/image083.png
.. |image84| image:: /_static/class1/module2/image084.png
.. |image85| image:: /_static/class1/module2/image085.png
.. |image86| image:: /_static/class1/module2/image086.png
.. |image87| image:: /_static/class1/module2/image087.png
.. |image88| image:: /_static/class1/module2/image088.png
.. |image89| image:: /_static/class1/module2/image089.png
.. |image90| image:: /_static/class1/module2/image090.png
.. |image91| image:: /_static/class1/module2/image091.png
.. |image92| image:: /_static/class1/module2/image092.png
.. |image93| image:: /_static/class1/module2/image093.png
.. |image94| image:: /_static/class1/module2/image094.png
.. |image95| image:: /_static/class1/module2/image095.png
.. |image96| image:: /_static/class1/module2/image096.png
.. |image97| image:: /_static/class1/module2/image097.png
.. |image98| image:: /_static/class1/module2/image098.png
.. |image99| image:: /_static/class1/module2/image099.png

